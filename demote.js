const ูุฏูุฑ = require( ../lib/isAdmin );

async function ุฃูุฑ_ุชุฎููุถ(ุณูู, ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ูุนุฑูุงุช_ุงููุฐููุฑูู, ุฑุณุงูุฉ) {
    try {
        // ุฃููุงู ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ูุฌููุนุฉ
        if (!ูุนุฑู_ุงูุฏุฑุฏุดุฉ.endsWith( @g.us )) {
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text:  ูููู ุงุณุชุฎุฏุงู ูุฐุง ุงูุฃูุฑ ููุท ูู ุงููุฌููุนุงุช! 
            });
            return;
        }

        // ุงูุชุญูู ูู ุญุงูุฉ ุงููุฏูุฑ ุฃููุงูุ ูุจู ุฃู ุนูููุงุช ุฃุฎุฑู
        try {
            const ุญุงูุฉ_ุงููุฏูุฑ = await ูุฏูุฑ(ุณูู, ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ุฑุณุงูุฉ.key.participant || ุฑุณุงูุฉ.key.remoteJid);
            
            if (!ุญุงูุฉ_ุงููุฏูุฑ.ุจูุช_ูุฏูุฑ) {
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text:  โ ุฎุทุฃ: ูุฑุฌู ุฌุนู ุงูุจูุช ูุฏูุฑุงู ุฃููุงู ูุงุณุชุฎุฏุงู ูุฐุง ุงูุฃูุฑ. 
                });
                return;
            }

            if (!ุญุงูุฉ_ุงููุฏูุฑ.ูุฑุณู_ูุฏูุฑ) {
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text:  โ ุฎุทุฃ: ููุท ูุฏุฑุงุก ุงููุฌููุนุฉ ูููููู ุงุณุชุฎุฏุงู ุฃูุฑ ุงูุชุฎููุถ. 
                });
                return;
            }
        } catch (ุฎุทุฃ_ุงููุฏูุฑ) {
            console.error( ุฎุทุฃ ูู ุงูุชุญูู ูู ุญุงูุฉ ุงููุฏูุฑ: , ุฎุทุฃ_ุงููุฏูุฑ);
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text:  โ ุฎุทุฃ: ูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู ุงูุจูุช ูุฏูุฑ ูู ูุฐู ุงููุฌููุนุฉ. 
            });
            return;
        }

        let ูุณุชุฎุฏู_ููุชูุฒูู = [];
        
        // ุงูุชุญูู ูู ุงููุณุชุฎุฏููู ุงููุฐููุฑูู
        if (ูุนุฑูุงุช_ุงููุฐููุฑูู && ูุนุฑูุงุช_ุงููุฐููุฑูู.length > 0) {
            ูุณุชุฎุฏู_ููุชูุฒูู = ูุนุฑูุงุช_ุงููุฐููุฑูู;
        }
        // ุงูุชุญูู ูู ุงูุฑุณุงูุฉ ุงูุชู ุชู ุงูุฑุฏ ุนูููุง
        else if (ุฑุณุงูุฉ.message?.extendedTextMessage?.contextInfo?.participant) {
            ูุณุชุฎุฏู_ููุชูุฒูู = [ุฑุณุงูุฉ.message.extendedTextMessage.contextInfo.participant];
        }
        
        // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูุณุชุฎุฏู ุนุจุฑ ุฃู ูู ุงูุทุฑููุชูู
        if (ูุณุชุฎุฏู_ููุชูุฒูู.length === 0) {
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text:  โ ุฎุทุฃ: ูุฑุฌู ุฐูุฑ ุงููุณุชุฎุฏู ุฃู ุงูุฑุฏ ุนูู ุฑุณุงูุชู ููุชุฎููุถ! 
            });
            return;
        }

        // ุฅุถุงูุฉ ุชุฃุฎูุฑ ูุชุฌูุจ ุงูุญุฏ ุงูุฃูุตู ูููุนุฏู
        await new Promise(ุญู => setTimeout(ุญู, 1000));

        await ุณูู.groupParticipantsUpdate(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ูุณุชุฎุฏู_ููุชูุฒูู, "demote");
        
        // ุงูุญุตูู ุนูู ุฃุณูุงุก ุงููุณุชุฎุฏููู ููู ูุณุชุฎุฏู ุชู ุชุฎููุถู
        const ุฃุณูุงุก_ุงููุณุชุฎุฏููู = await Promise.all(ูุณุชุฎุฏู_ููุชูุฒูู.map(async ูุนุฑู => {
            return `@${ูุนุฑู.split( @ )[0]}`;
        }));

        // ุฅุถุงูุฉ ุชุฃุฎูุฑ ูุชุฌูุจ ุงูุญุฏ ุงูุฃูุตู ูููุนุฏู
        await new Promise(ุญู => setTimeout(ุญู, 1000));

        const ุฑุณุงูุฉ_ุงูุชุฎููุถ = `*ใ ุชุฎููุถ ุฑุชุจุฉ ุงููุฌููุนุฉ ใ*\n\n` +
            `๐ค *ุงููุณุชุฎุฏู ุงูุฐู ุชู ุชุฎููุถ ุฑุชุจุชู${ูุณุชุฎุฏู_ููุชูุฒูู.length > 1 ?  s  :   }:*\n` +
            `${ุฃุณูุงุก_ุงููุณุชุฎุฏููู.map(ุงุณู => `โข ${ุงุณู}`).join( \n )}\n\n` +
            `๐ *ุชู ุชุฎููุถ ุฑุชุจุชู ุจูุงุณุทุฉ:* @${ุฑุณุงูุฉ.key.participant ? ุฑุณุงูุฉ.key.participant.split( @ )[0] : ุฑุณุงูุฉ.key.remoteJid.split( @ )[0]}\n\n` +
            `๐ *ุชุงุฑูุฎ:* ${new Date().toLocaleString()}`;
        
        await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
            text: ุฑุณุงูุฉ_ุงูุชุฎููุถ,
            mentions: [...ูุณุชุฎุฏู_ููุชูุฒูู, ุฑุณุงูุฉ.key.participant || ุฑุณุงูุฉ.key.remoteJid]
        });
    } catch (ุฎุทุฃ) {
        console.error( ุฎุทุฃ ูู ุฃูุฑ ุงูุชุฎููุถ: , ุฎุทุฃ);
        if (ุฎุทุฃ.data === 429) {
            await new Promise(ุญู => setTimeout(ุญู, 2000));
            try {
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text:  โ ุชู ุงููุตูู ุฅูู ุงูุญุฏ ุงูุฃูุตู ูููุนุฏู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุจุถุน ุซูุงูู. 
                });
            } catch (ุฎุทุฃ_ุฅุนุงุฏุฉ_ุงููุญุงููุฉ) {
                console.error( ุฎุทุฃ ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ: , ุฎุทุฃ_ุฅุนุงุฏุฉ_ุงููุญุงููุฉ);
            }
        } else {
            try {
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text:  โ ูุดู ูู ุชุฎููุถ ุงููุณุชุฎุฏู(ูู). ุชุฃูุฏ ูู ุฃู ุงูุจูุช ูุฏูุฑ ููู ุตูุงุญูุงุช ูุงููุฉ. 
                });
            } catch (ุฎุทุฃ_ุงูุฅุฑุณุงู) {
                console.error( ุฎุทุฃ ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุฎุทุฃ: , ุฎุทุฃ_ุงูุฅุฑุณุงู);
            }
        }
    }
}

// ุฏุงูุฉ ููุชุนุงูู ูุน ุงูุชุดุงู ุงูุชุฎููุถ ุงูุชููุงุฆู
async function ุงูุชุนุงูู_ูุน_ุญุฏุซ_ุงูุชุฎููุถ(ุณูู, ูุนุฑู_ุงููุฌููุนุฉ, ุงููุดุงุฑููู, ุงููุคูู) {
    try {
        // ูุญุต ุณูุงูุฉ ูููุดุงุฑููู
        if (!Array.isArray(ุงููุดุงุฑููู) || ุงููุดุงุฑููู.length === 0) {
            return;
        }

        // ุฅุถุงูุฉ ุชุฃุฎูุฑ ูุชุฌูุจ ุงูุญุฏ ุงูุฃูุตู ูููุนุฏู
        await new Promise(ุญู => setTimeout(ุญู, 1000));

        // ุงูุญุตูู ุนูู ุฃุณูุงุก ุงููุณุชุฎุฏููู ูููุดุงุฑููู ุงูุฐูู ุชู ุชุฎููุถูู
        const ุฃุณูุงุก_ุงููุณุชุฎุฏููู_ุงููุฎูุถูู = await Promise.all(ุงููุดุงุฑููู.map(async ูุนุฑู => {
            // ุงูุชุนุงูู ูุน ุงูุญุงูุฉ ุญูุซ ูุฏ ูููู ุงููุนุฑู ูุงุฆููุง ุฃู ููุณ ุณูุณูุฉ ูุตูุฉ
            const ุณูุณูุฉ_ุงููุนุฑู = typeof ูุนุฑู ===  string  ? ูุนุฑู : (ูุนุฑู.id || ูุนุฑู.toString());
            return `@${ุณูุณูุฉ_ุงููุนุฑู.split( @ )[0]}`;
        }));

        let ูุฎูุถ_ูู_ูุจู;
        let ูุงุฆูุฉ_ุงููุฐููุฑูู = ุงููุดุงุฑููู.map(ูุนุฑู => {
            // ุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุฅุดุงุฑุงุช ูู ุณูุงุณู ูุตูุฉ ูุนุฑู ุตุญูุญุฉ
            return typeof ูุนุฑู ===  string  ? ูุนุฑู : (ูุนุฑู.id || ูุนุฑู.toString());
        });

        if (ุงููุคูู && ุงููุคูู.length > 0) {
            // ุชุฃูุฏ ูู ุฃู ุงููุคูู ูู ุงูุชูุณูู ุงูุตุญูุญ
            const ูุนุฑู_ุงููุคูู = typeof ุงููุคูู ===  string  ? ุงููุคูู : (ุงููุคูู.id || ุงููุคูู.toString());
            ูุฎูุถ_ูู_ูุจู = `@${ูุนุฑู_ุงููุคูู.split( @ )[0]}`;
            ูุงุฆูุฉ_ุงููุฐููุฑูู.push(ูุนุฑู_ุงููุคูู);
        } else {
            ูุฎูุถ_ูู_ูุจู =  ุงููุธุงู ;
        }

        // ุฅุถุงูุฉ ุชุฃุฎูุฑ ูุชุฌูุจ ุงูุญุฏ ุงูุฃูุตู ูููุนุฏู
        await new Promise(ุญู => setTimeout(ุญู, 1000));

        const ุฑุณุงูุฉ_ุงูุชุฎููุถ = `*ใ ุชุฎููุถ ุฑุชุจุฉ ุงููุฌููุนุฉ ใ*\n\n` +
            `๐ค *ุงููุณุชุฎุฏู ุงูุฐู ุชู ุชุฎููุถ ุฑุชุจุชู${ุงููุดุงุฑููู.length > 1 ?  s  :   }:*\n` +
            `${ุฃุณูุงุก_ุงููุณุชุฎุฏููู_ุงููุฎูุถูู.map(ุงุณู => `โข ${ุงุณู}`).join( \n )}\n\n` +
            `๐ *ุชู ุชุฎููุถ ุฑุชุจุชู ุจูุงุณุทุฉ:* ${ูุฎูุถ_ูู_ูุจู}\n\n` +
            `๐ *ุชุงุฑูุฎ:* ${new Date().toLocaleString()}`;
        
        await ุณูู.sendMessage(ูุนุฑู_ุงููุฌููุนุฉ, {
            text: ุฑุณุงูุฉ_ุงูุชุฎููุถ,
            mentions: ูุงุฆูุฉ_ุงููุฐููุฑูู
        });
    } catch (ุฎุทุฃ) {
        console.error( ุฎุทุฃ ูู ุงูุชุนุงูู ูุน ุญุฏุซ ุงูุชุฎููุถ: , ุฎุทุฃ);
        if (ุฎุทุฃ.data === 429) {
            await new Promise(ุญู => setTimeout(ุญู, 2000));
        }
    }
}

module.exports = { ุฃูุฑ_ุชุฎููุถ, ุงูุชุนุงูู_ูุน_ุญุฏุซ_ุงูุชุฎููุถ };