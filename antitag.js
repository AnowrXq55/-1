const { ุชุนููู_ููุน_ุงูุชุงุฌ, ุงูุญุตูู_ุนูู_ููุน_ุงูุชุงุฌ, ุฅุฒุงูุฉ_ููุน_ุงูุชุงุฌ } = require( ../lib/index );
const ูุฏูุฑ = require( ../lib/isAdmin );

async function ุงูุชุนุงูู_ูุน_ุฃูุฑ_ููุน_ุงูุชุงุฌ(ุณูู, ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ุฑุณุงูุฉ_ุงููุณุชุฎุฏู, ูุนุฑู_ุงููุฑุณู, ูุฑุณู_ูุฏูุฑ, ุฑุณุงูุฉ) {
    try {
        if (!ูุฑุณู_ูุฏูุฑ) {
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text:  ```ูููุฏุฑุงุก ููุท!```  },{quoted :ุฑุณุงูุฉ});
            return;
        }

        const ุงูุจุงุฏุฆุฉ =  . ;
        const ุงููุณุงุฆุท = ุฑุณุงูุฉ_ุงููุณุชุฎุฏู.slice(9).toLowerCase().trim().split(   );
        const ุงูุฅุฌุฑุงุก = ุงููุณุงุฆุท[0];

        if (!ุงูุฅุฌุฑุงุก) {
            const ุทุฑููุฉ_ุงูุงุณุชุฎุฏุงู = `\`\`\`ุฅุนุฏุงุฏุงุช ููุน ุงูุชุงุฌ\n\n${ุงูุจุงุฏุฆุฉ}antitag on\n${ุงูุจุงุฏุฆุฉ}antitag set delete | kick\n${ุงูุจุงุฏุฆุฉ}antitag off\n\`\`\``;
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text: ุทุฑููุฉ_ุงูุงุณุชุฎุฏุงู },{quoted :ุฑุณุงูุฉ});
            return;
        }

        switch (ุงูุฅุฌุฑุงุก) {
            case  on :
                const ุงูุฅุนุฏุงุฏุงุช_ุงูุญุงููุฉ = await ุงูุญุตูู_ุนูู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on );
                if (ุงูุฅุนุฏุงุฏุงุช_ุงูุญุงููุฉ?.ููุนูู) {
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text:  *_ููุน ุงูุชุงุฌ ููุนูู ุจุงููุนู_*  },{quoted :ุฑุณุงูุฉ});
                    return;
                }
                const ุงููุชูุฌุฉ = await ุชุนููู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on ,  delete );
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text: ุงููุชูุฌุฉ ?  *_ุชู ุชูุนูู ููุน ุงูุชุงุฌ_*  :  *_ูุดู ูู ุชูุนูู ููุน ุงูุชุงุฌ_*  
                },{quoted :ุฑุณุงูุฉ});
                break;

            case  off :
                await ุฅุฒุงูุฉ_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on );
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text:  *_ุชู ุชุนุทูู ููุน ุงูุชุงุฌ_*  },{quoted :ุฑุณุงูุฉ});
                break;

            case  set :
                if (ุงููุณุงุฆุท.length < 2) {
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                        text: `*_ูุฑุฌู ุชุญุฏูุฏ ุฅุฌุฑุงุก: ${ุงูุจุงุฏุฆุฉ}antitag set delete | kick_*` 
                    },{quoted :ุฑุณุงูุฉ});
                    return;
                }
                const ุฅุฌุฑุงุก_ุงูุชุนููู = ุงููุณุงุฆุท[1];
                if (![ delete ,  kick ].includes(ุฅุฌุฑุงุก_ุงูุชุนููู)) {
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                        text:  *_ุฅุฌุฑุงุก ุบูุฑ ุตุงูุญ. ุงุฎุชุฑ delete ุฃู kick._*  
                    },{quoted :ุฑุณุงูุฉ});
                    return;
                }
                const ูุชูุฌุฉ_ุงูุชุนููู = await ุชุนููู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on , ุฅุฌุฑุงุก_ุงูุชุนููู);
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text: ูุชูุฌุฉ_ุงูุชุนููู ? `*_ุชู ุชุนููู ุฅุฌุฑุงุก ููุน ุงูุชุงุฌ ุฅูู ${ุฅุฌุฑุงุก_ุงูุชุนููู}_*` :  *_ูุดู ูู ุชุนููู ุฅุฌุฑุงุก ููุน ุงูุชุงุฌ_*  
                },{quoted :ุฑุณุงูุฉ});
                break;

            case  get :
                const ุงูุญุงูุฉ = await ุงูุญุตูู_ุนูู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on );
                const ุฅุนุฏุงุฏุงุช_ุงูุฅุฌุฑุงุก = await ุงูุญุตูู_ุนูู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on );
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                    text: `*_ุฅุนุฏุงุฏุงุช ููุน ุงูุชุงุฌ:_*\nุงูุญุงูุฉ: ${ุงูุญุงูุฉ ?  ููุนูู  :  ูุนุทู }\nุงูุฅุฌุฑุงุก: ${ุฅุนุฏุงุฏุงุช_ุงูุฅุฌุฑุงุก ? ุฅุนุฏุงุฏุงุช_ุงูุฅุฌุฑุงุก.ุฅุฌุฑุงุก :  ุบูุฑ ูุนูู }` 
                },{quoted :ุฑุณุงูุฉ});
                break;

            default:
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text: `*_ุงุณุชุฎุฏู ${ุงูุจุงุฏุฆุฉ}antitag ูุฑุคูุฉ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู._*` },{quoted :ุฑุณุงูุฉ});
        }
    } catch (ุฎุทุฃ) {
        console.error( ุฎุทุฃ ูู ุฃูุฑ ููุน ุงูุชุงุฌ: , ุฎุทุฃ);
        await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { text:  *_ุฎุทุฃ ูู ูุนุงูุฌุฉ ุฃูุฑ ููุน ุงูุชุงุฌ_*  },{quoted :ุฑุณุงูุฉ});
    }
}

async function ุงูุชุนุงูู_ูุน_ุงูุชุดุงู_ุงูุชุงุฌ(ุณูู, ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ุฑุณุงูุฉ, ูุนุฑู_ุงููุฑุณู) {
    try {
        const ุฅุนุฏุงุฏุงุช_ููุน_ุงูุชุงุฌ = await ุงูุญุตูู_ุนูู_ููุน_ุงูุชุงุฌ(ูุนุฑู_ุงูุฏุฑุฏุดุฉ,  on );
        if (!ุฅุนุฏุงุฏุงุช_ููุน_ุงูุชุงุฌ || !ุฅุนุฏุงุฏุงุช_ููุน_ุงูุชุงุฌ.ููุนูู) return;

        // ุงูุญุตูู ุนูู ูุนุฑูุงุช ุงููุฐููุฑูู ูู contextInfo (ุฅุดุงุฑุงุช ุตุญูุญุฉ)
        const ูุนุฑูุงุช_ุงููุฐููุฑูู = ุฑุณุงูุฉ.message?.extendedTextMessage?.contextInfo?.mentionedJid || [];
        
        // ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุฌููุน ุฃููุงุน ุงูุฑุณุงุฆู ุงููุญุชููุฉ
        const ูุต_ุงูุฑุณุงูุฉ = (
            ุฑุณุงูุฉ.message?.conversation ||
            ุฑุณุงูุฉ.message?.extendedTextMessage?.text ||
            ุฑุณุงูุฉ.message?.imageMessage?.caption ||
            ุฑุณุงูุฉ.message?.videoMessage?.caption ||
              
        );

        // ุงูุนุซูุฑ ุนูู ุฌููุน ุงูุฅุดุงุฑุงุช @ ูู ุงููุต ุจุงุณุชุฎุฏุงู regex ูุญุณู
        // ุชุทุงุจู: @123456789ุ @โจ+91 70239 51514โฉุ @~..ุ @217875470114951ุ ุฅูุฎ.
        const ุฅุดุงุฑุงุช_ุงููุต = ูุต_ุงูุฑุณุงูุฉ.match(/@[\d+\s\-()~.]+/g) || [];
        
        // ุฃูุถูุง ูุทุงุจูุฉ ุงูุฅุดุงุฑุงุช ุงูุฑูููุฉ ููุท (ูุซู @217875470114951)
        const ุฅุดุงุฑุงุช_ุฑูููุฉ = ูุต_ุงูุฑุณุงูุฉ.match(/@\d{10,}/g) || [];
        
        // ุฌูุน ุฌููุน ุงูุฅุดุงุฑุงุช ูุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
        const ุฌููุน_ุงูุฅุดุงุฑุงุช = [...new Set([...ูุนุฑูุงุช_ุงููุฐููุฑูู, ...ุฅุดุงุฑุงุช_ุงููุต, ...ุฅุดุงุฑุงุช_ุฑูููุฉ])];
        
        // ุนุฏ ุงูุฅุดุงุฑุงุช ุงูุฑูููุฉ ุงููุฑูุฏุฉ (ุฃููุงุท tagall ููุจูุชุงุช)
        const ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ_ุงููุฑูุฏุฉ = new Set();
        ุฅุดุงุฑุงุช_ุฑูููุฉ.forEach(ุฅุดุงุฑุฉ => {
            const ูุทุงุจูุฉ_ุฑูููุฉ = ุฅุดุงุฑุฉ.match(/@(\d+)/);
            if (ูุทุงุจูุฉ_ุฑูููุฉ) ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ_ุงููุฑูุฏุฉ.add(ูุทุงุจูุฉ_ุฑูููุฉ[1]);
        });
        
        // ุนุฏ ุงูุฅุดุงุฑุงุช ูู ูุตูููุฉ mentionedJid (ุฅุดุงุฑุงุช ูุงุชุณุงุจ ุงูุตุญูุญุฉ)
        const ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงููุนุฑููุฉ = ูุนุฑูุงุช_ุงููุฐููุฑูู.length;
        
        // ุนุฏ ุงูุฅุดุงุฑุงุช ุงูุฑูููุฉ ุงููุฑูุฏุฉ ุงูููุฌูุฏุฉ ูู ุงููุต (ููุท tagall ููุจูุชุงุช)
        const ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ = ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ_ุงููุฑูุฏุฉ.size;
        
        // ุงุณุชุฎุฏุงู ุงูุนุฏุฏ ุงูุฃุนูู (ุฅูุง ุฅุดุงุฑุงุช ุตุญูุญุฉ ุฃู ุฅุดุงุฑุงุช ูุงุฆูุฉ ุนูู ุงููุต)
        // ูุฐุง ูุถูู ุงูุชุดุงููุง ููุฅุดุงุฑุงุช ุงูููุงุณูุฉ ูุฃููุงุท tagall ููุจูุชุงุช
        const ุฅุฌูุงูู_ุงูุฅุดุงุฑุงุช = Math.max(ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงููุนุฑููุฉ, ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ);

        // ุงูุชุญูู ุฅุฐุง ูุงูุช ุฑุณุงูุฉ ูุฌููุนุฉ ูููุง ุฅุดุงุฑุงุช ูุชุนุฏุฏุฉ
        if (ุฅุฌูุงูู_ุงูุฅุดุงุฑุงุช >= 3) {
            // ุงูุญุตูู ุนูู ุฃุนุถุงุก ุงููุฌููุนุฉ ููุชุญูู ุฅุฐุง ูุงู ูุดูุฑ ุฅูู ูุนุธู/ุฌููุน ุงูุฃุนุถุงุก
            const ุจูุงูุงุช_ุงููุฌููุนุฉ = await ุณูู.groupMetadata(ูุนุฑู_ุงูุฏุฑุฏุดุฉ);
            const ุงููุดุงุฑููู = ุจูุงูุงุช_ุงููุฌููุนุฉ.participants || [];
            
            // ุฅุฐุง ูุงูุช ุงูุฅุดุงุฑุงุช ุฃูุซุฑ ูู 50% ูู ุฃุนุถุงุก ุงููุฌููุนุฉุ ุงุนุชุจุฑูุง tagall
            const ุญุฏ_ุงูุฅุดุงุฑุงุช = Math.ceil(ุงููุดุงุฑููู.length * 0.5);
            
            // ุฃูุถูุง ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุฅุดุงุฑุงุช ุฑูููุฉ ูุซูุฑุฉ ูู ุงููุต (ููุท tagall ููุจูุชุงุช)
            // ูุฐุง ููุชุดู ุงูุจูุชุงุช ุงูุชู ุชุณุชุฎุฏู ูุนุฑูุงุช ุฑูููุฉ ุจุฏูุงู ูู ุงูุฅุดุงุฑุงุช ุงูุตุญูุญุฉ
            const ูุฏูู_ูุซูุฑ_ูู_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ = ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ >= 10 || 
                                          (ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ >= 5 && ุนุฏุฏ_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ >= ุญุฏ_ุงูุฅุดุงุฑุงุช);
            
            // ุงูุชูุดูุท ุฅุฐุง: ุชุฌุงูุฒุช ุงูุฅุดุงุฑุงุช ุงูููุงุณูุฉ ุงูุญุฏ ุฃู ุชู ุงูุชุดุงู ุฅุดุงุฑุงุช ุฑูููุฉ ูุซูุฑุฉ
            if (ุฅุฌูุงูู_ุงูุฅุดุงุฑุงุช >= ุญุฏ_ุงูุฅุดุงุฑุงุช || ูุฏูู_ูุซูุฑ_ูู_ุงูุฅุดุงุฑุงุช_ุงูุฑูููุฉ) {
                
                const ุงูุฅุฌุฑุงุก = ุฅุนุฏุงุฏุงุช_ููุน_ุงูุชุงุฌ.ุฅุฌุฑุงุก ||  delete ;
                
                if (ุงูุฅุฌุฑุงุก ===  delete ) {
                    // ุญุฐู ุงูุฑุณุงูุฉ
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                        delete: {
                            remoteJid: ูุนุฑู_ุงูุฏุฑุฏุดุฉ,
                            fromMe: false,
                            id: ุฑุณุงูุฉ.key.id,
                            participant: ูุนุฑู_ุงููุฑุณู
                        }
                    });
                    
                    // ุฅุฑุณุงู ุชุญุฐูุฑ
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                        text: `โ๏ธ *ุชู ุงูุชุดุงู tagall!*.`
                    }, { quoted: ุฑุณุงูุฉ });
                    
                } else if (ุงูุฅุฌุฑุงุก ===  kick ) {
                    // ุฃููุงู ุญุฐู ุงูุฑุณุงูุฉ
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                        delete: {
                            remoteJid: ูุนุฑู_ุงูุฏุฑุฏุดุฉ,
                            fromMe: false,
                            id: ุฑุณุงูุฉ.key.id,
                            participant: ูุนุฑู_ุงููุฑุณู
                        }
                    });

                    // ุซู ุทุฑุฏ ุงููุณุชุฎุฏู
                    await ุณูู.groupParticipantsUpdate(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, [ูุนุฑู_ุงููุฑุณู], "remove");

                    // ุฅุฑุณุงู ุฅุดุนุงุฑ
                    const ุฃุณูุงุก_ุงููุณุชุฎุฏููู = [`@${ูุนุฑู_ุงููุฑุณู.split( @ )[0]}`];
                    await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                        text: `๐ซ *ุชู ุงูุชุดุงู ููุน ุงูุชุงุฌ!*\n\n${ุฃุณูุงุก_ุงููุณุชุฎุฏููู.join( ,  )} ุชู ุทุฑุฏู ุจุณุจุจ ุงูุฅุดุงุฑุฉ ุฅูู ุฌููุน ุงูุฃุนุถุงุก.`,
                        mentions: [ูุนุฑู_ุงููุฑุณู]
                    }, { quoted: ุฑุณุงูุฉ });
                }
            }
        }
    } catch (ุฎุทุฃ) {
        console.error( ุฎุทุฃ ูู ุงูุชุดุงู ุงูุชุงุฌ: , ุฎุทุฃ);
    }
}

module.exports = {
    ุงูุชุนุงูู_ูุน_ุฃูุฑ_ููุน_ุงูุชุงุฌ,
    ุงูุชุนุงูู_ูุน_ุงูุชุดุงู_ุงูุชุงุฌ
};