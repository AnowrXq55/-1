const { بوتات } = require( ../lib/antilink );
const { تعيين_منع_الروابط, الحصول_على_منع_الروابط, إزالة_منع_الروابط } = require( ../lib/index );
const مدير = require( ../lib/isAdmin );

async function التعامل_مع_أمر_منع_الروابط(سوك, معرف_الدردشة, رسالة_المستخدم, معرف_المرسل, مرسل_مدير, رسالة) {
    try {
        if (!مرسل_مدير) {
            await سوك.sendMessage(معرف_الدردشة, { text:  ```للمدراء فقط!```  }, { quoted: رسالة });
            return;
        }

        const البادئة =  . ;
        const الوسائط = رسالة_المستخدم.slice(9).toLowerCase().trim().split(   );
        const الإجراء = الوسائط[0];

        if (!الإجراء) {
            const طريقة_الاستخدام = `\`\`\`إعدادات منع الروابط\n\n${البادئة}antilink on\n${البادئة}antilink set delete | kick | warn\n${البادئة}antilink off\n\`\`\``;
            await سوك.sendMessage(معرف_الدردشة, { text: طريقة_الاستخدام }, { quoted: رسالة });
            return;
        }

        switch (الإجراء) {
            case  on :
                const الإعدادات_الحالية = await الحصول_على_منع_الروابط(معرف_الدردشة,  on );
                if (الإعدادات_الحالية?.مفعّل) {
                    await سوك.sendMessage(معرف_الدردشة, { text:  *_منع الروابط مفعّل بالفعل_*  }, { quoted: رسالة });
                    return;
                }
                const النتيجة = await تعيين_منع_الروابط(معرف_الدردشة,  on ,  delete );
                await سوك.sendMessage(معرف_الدردشة, { 
                    text: النتيجة ?  *_تم تفعيل منع الروابط_*  :  *_فشل في تفعيل منع الروابط_*  
                },{ quoted: رسالة });
                break;

            case  off :
                await إزالة_منع_الروابط(معرف_الدردشة,  on );
                await سوك.sendMessage(معرف_الدردشة, { text:  *_تم تعطيل منع الروابط_*  }, { quoted: رسالة });
                break;

            case  set :
                if (الوسائط.length < 2) {
                    await سوك.sendMessage(معرف_الدردشة, { 
                        text: `*_يرجى تحديد إجراء: ${البادئة}antilink set delete | kick | warn_*` 
                    }, { quoted: رسالة });
                    return;
                }
                const إجراء_التعيين = الوسائط[1];
                if (![ delete ,  kick ,  warn ].includes(إجراء_التعيين)) {
                    await سوك.sendMessage(معرف_الدردشة, { 
                        text:  *_إجراء غير صالح. اختر delete، kick، أو warn._*  
                    }, { quoted: رسالة });
                    return;
                }
                const نتيجة_التعيين = await تعيين_منع_الروابط(معرف_الدردشة,  on , إجراء_التعيين);
                await سوك.sendMessage(معرف_الدردشة, { 
                    text: نتيجة_التعيين ? `*_تم تعيين إجراء منع الروابط إلى ${إجراء_التعيين}_*` :  *_فشل في تعيين إجراء منع الروابط_*  
                }, { quoted: رسالة });
                break;

            case  get :
                const الحالة = await الحصول_على_منع_الروابط(معرف_الدردشة,  on );
                const إعدادات_الإجراء = await الحصول_على_منع_الروابط(معرف_الدردشة,  on );
                await سوك.sendMessage(معرف_الدردشة, { 
                    text: `*_إعدادات منع الروابط:_*\nالحالة: ${الحالة ?  مفعّل  :  معطل }\nالإجراء: ${إعدادات_الإجراء ? إعدادات_الإجراء.إجراء :  غير معين }` 
                }, { quoted: رسالة });
                break;

            default:
                await سوك.sendMessage(معرف_الدردشة, { text: `*_استخدم ${البادئة}antilink لرؤية طريقة الاستخدام._*` });
        }
    } catch (خطأ) {
        console.error( خطأ في أمر منع الروابط: , خطأ);
        await سوك.sendMessage(معرف_الدردشة, { text:  *_خطأ في معالجة أمر منع الروابط_*  });
    }
}

async function التعامل_مع_اكتشاف_الروابط(سوك, معرف_الدردشة, رسالة, رسالة_المستخدم, معرف_المرسل) {
    const إعدادات_منع_الروابط = الحصول_على_إعداد_منع_الروابط(معرف_الدردشة);
    if (إعدادات_منع_الروابط ===  off ) return;

    console.log(`إعدادات منع الروابط لـ ${معرف_الدردشة}: ${إعدادات_منع_الروابط}`);
    console.log(`التحقق من الرسالة للروابط: ${رسالة_المستخدم}`);
    
    // تسجيل كائن الرسالة الكامل لتشخيص بنية الرسالة
    console.log("كائن الرسالة الكامل: ", JSON.stringify(رسالة, null, 2));

    let يجب_الحذف = false;

    const أنماط_الروابط = {
        مجموعة_واتساب: /chat\.whatsapp\.com\/[A-Za-z0-9]{20,}/i,
        قناة_واتساب: /wa\.me\/channel\/[A-Za-z0-9]{20,}/i,
        تيليجرام: /t\.me\/[A-Za-z0-9_]+/i,
        // تطابق:
        // - روابط كاملة مع بروتوكول (http/https)
        // - روابط تبدأ بـ www.
        // - نطاقات عارية في أي مكان في النص، حتى عندما تكون مرفقة بالنص
        //   مثال: "helloinstagram.comworld" أو "testhttps://x.com"
        جميع_الروابط: /https?:\/\/\S+|www\.\S+|(?:[a-z0-9-]+\.)+[a-z]{2,}(?:\/\S*)?/i,
    };

    // اكتشاف روابط مجموعات واتساب
    if (إعدادات_منع_الروابط ===  whatsappGroup ) {
        console.log( حماية روابط مجموعات واتساب مفعّلة. );
        if (أنماط_الروابط.مجموعة_واتساب.test(رسالة_المستخدم)) {
            console.log( تم اكتشاف رابط مجموعة واتساب! );
            يجب_الحذف = true;
        }
    } else if (إعدادات_منع_الروابط ===  whatsappChannel  && أنماط_الروابط.قناة_واتساب.test(رسالة_المستخدم)) {
        يجب_الحذف = true;
    } else if (إعدادات_منع_الروابط ===  telegram  && أنماط_الروابط.تيليجرام.test(رسالة_المستخدم)) {
        يجب_الحذف = true;
    } else if (إعدادات_منع_الروابط ===  allLinks  && أنماط_الروابط.جميع_الروابط.test(رسالة_المستخدم)) {
        يجب_الحذف = true;
    }

    if (يجب_الحذف) {
        const معرف_الرسالة_المقتبسة = رسالة.key.id; // الحصول على معرف الرسالة للحذف
        const معرف_المشارك_المقتبس = رسالة.key.participant || معرف_المرسل; // الحصول على معرف المشارك

        console.log(`محاولة حذف الرسالة بالمعرف: ${معرف_الرسالة_المقتبسة} من المشارك: ${معرف_المشارك_المقتبس}`);

        try {
            await سوك.sendMessage(معرف_الدردشة, {
                delete: { remoteJid: معرف_الدردشة, fromMe: false, id: معرف_الرسالة_المقتبسة, participant: معرف_المشارك_المقتبس },
            });
            console.log(`تم حذف الرسالة بالمعرف ${معرف_الرسالة_المقتبسة} بنجاح.`);
        } catch (خطأ) {
            console.error( فشل في حذف الرسالة: , خطأ);
        }

        const قائمة_المذكورين = [معرف_المرسل];
        await سوك.sendMessage(معرف_الدردشة, { text: `تحذير! @${معرف_المرسل.split( @ )[0]}، نشر الروابط غير مسموح.`, mentions: قائمة_المذكورين });
    } else {
        console.log( لم يتم اكتشاف روابط أو الحماية غير مفعّلة لهذا النوع من الروابط. );
    }
}

module.exports = {
    التعامل_مع_أمر_منع_الروابط,
    التعامل_مع_اكتشاف_الروابط,
};