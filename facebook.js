const axios = require( axios );
const fs = require( fs );
const path = require( path );

async function ุฃูุฑ_ููุณุจูู(ุณูู, ูุนุฑู_ุงูุฏุฑุฏุดุฉ, ุฑุณุงูุฉ) {
    try {
        const ูุต = ุฑุณุงูุฉ.message?.conversation || ุฑุณุงูุฉ.message?.extendedTextMessage?.text;
        const ุฑุงุจุท = ูุต.split(   ).slice(1).join(   ).trim();
        
        if (!ุฑุงุจุท) {
            return await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text: "ูุฑุฌู ุชูููุฑ ุฑุงุจุท ููุฏูู ููุณุจูู.\nูุซุงู: .fb https://www.facebook.com/..."
            }, { quoted: ุฑุณุงูุฉ });
        }

        // ุงูุชุญูู ูู ุตุญุฉ ุฑุงุจุท ููุณุจูู
        if (!ุฑุงุจุท.includes( facebook.com )) {
            return await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text: "ูุฐุง ููุณ ุฑุงุจุท ููุณุจูู."
            }, { quoted: ุฑุณุงูุฉ });
        }

        // ุฅุฑุณุงู ุชูุงุนู ุงูุชุญููู
        await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
            react: { text:  ๐ , key: ุฑุณุงูุฉ.key }
        });

        // ุชุญููู ุฑูุงุจุท ุงููุดุงุฑูุฉ/ุงููุฎุชุตุฑุฉ ุฅูู ูุฌูุชูุง ุงูููุงุฆูุฉ ุฃููุงู
        let ุฑุงุจุท_ูุญููู = ุฑุงุจุท;
        try {
            const ุงุณุชุฌุงุจุฉ = await axios.get(ุฑุงุจุท, { timeout: 20000, maxRedirects: 10, headers: {  User-Agent :  Mozilla/5.0  } });
            const ูููู = ุงุณุชุฌุงุจุฉ?.request?.res?.responseUrl;
            if (ูููู && typeof ูููู ===  string ) {
                ุฑุงุจุท_ูุญููู = ูููู;
            }
        } catch {
            // ุชุฌุงูู ุฃุฎุทุงุก ุงูุชุญูููุ ุงุณุชุฎุฏุงู ุงูุฑุงุจุท ุงูุฃุตูู
        }

        // ุงุณุชุฎุฏุงู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช Hanggts
        async function ุฌูุจ_ูู_API(ุฑ) {
            const ุฑุงุจุท_API = `https://api.hanggts.xyz/download/facebook?url=${encodeURIComponent(ุฑ)}`;
            
            try {
                const ุงุณุชุฌุงุจุฉ = await axios.get(ุฑุงุจุท_API, {
                    timeout: 20000,
                    headers: {
                         accept :  */* ,
                         User-Agent :  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
                    },
                    maxRedirects: 5,
                    validateStatus: ุณ => ุณ >= 200 && ุณ < 500
                });
                
                if (ุงุณุชุฌุงุจุฉ.data) {
                    // ูุจูู ุงูุงุณุชุฌุงุจุฉ ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ุตุญูุญุฉุ ุฃู ุฅุฐุง ูุงู ูุฏู ุงูุงุณุชุฌุงุจุฉ ุญููู ุจูุงูุงุช/ูุชูุฌุฉ/ุฑุงุจุท
                    if (ุงุณุชุฌุงุจุฉ.data.status === true || 
                        ุงุณุชุฌุงุจุฉ.data.result || 
                        ุงุณุชุฌุงุจุฉ.data.data || 
                        ุงุณุชุฌุงุจุฉ.data.url || 
                        ุงุณุชุฌุงุจุฉ.data.download || 
                        ุงุณุชุฌุงุจุฉ.data.video) {
                        return { ุงุณุชุฌุงุจุฉ, ุงุณู_API:  Hanggts API  };
                    }
                }
            } catch (ุฎุทุฃ) {
                console.error(`ูุดู Hanggts API: ${ุฎุทุฃ.message}`);
            }
            throw new Error( ูุดู Hanggts API );
        }

        // ุญุงูู ุฃููุงู ูุน ุงูุฑุงุจุท ุงููุญูููุ ุซู ุงูุฑุงุจุท ุงูุฃุตูู ูุจุฏูู
        let ูุชูุฌุฉ_API;
        try {
            ูุชูุฌุฉ_API = await ุฌูุจ_ูู_API(ุฑุงุจุท_ูุญููู);
        } catch {
            ูุชูุฌุฉ_API = await ุฌูุจ_ูู_API(ุฑุงุจุท);
        }

        const ุงุณุชุฌุงุจุฉ = ูุชูุฌุฉ_API.ุงุณุชุฌุงุจุฉ;
        const ุงุณู_API = ูุชูุฌุฉ_API.ุงุณู_API;
        const ุจูุงูุงุช = ุงุณุชุฌุงุจุฉ.data;

        let ููุฏูู_ููุณ = null;
        let ุนููุงู = null;

        // ุงูุชุนุงูู ูุน ุชูุณูู ุงุณุชุฌุงุจุฉ Hanggts API
        // ุญุงูู ุงูุชุญููู ุญุชู ูู ูู ุชูู ุงูุญุงูุฉ ุตุฑูุญุฉ
        if (ุจูุงูุงุช) {
            // ุฌุฑุจ ููุงูู ุงูุงุณุชุฌุงุจุฉ ุงููุญุชููุฉ ุงููุฎุชููุฉ
            if (ุจูุงูุงุช.result) {
                // ุชูุณูู Hanggts API: ุจูุงูุงุช.result.media.video_hd ุฃู video_sd
                if (ุจูุงูุงุช.result.media) {
                    // ุชูุถู HDุ ุซู SD ูุจุฏูู
                    ููุฏูู_ููุณ = ุจูุงูุงุช.result.media.video_hd || ุจูุงูุงุช.result.media.video_sd;
                    ุนููุงู = ุจูุงูุงุช.result.info?.title || ุจูุงูุงุช.result.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                }
                // ุชุญูู ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ ูุงุฆู ูุน ุฑุงุจุท
                else if (typeof ุจูุงูุงุช.result ===  object  && ุจูุงูุงุช.result.url) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.result.url;
                    ุนููุงู = ุจูุงูุงุช.result.title || ุจูุงูุงุช.result.caption || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } 
                // ุชุญูู ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ ุณูุณูุฉ (ุฑุงุจุท ูุจุงุดุฑ)
                else if (typeof ุจูุงูุงุช.result ===  string  && ุจูุงูุงุช.result.startsWith( http )) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.result;
                    ุนููุงู = ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                }
                // ุชุญูู ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ ููุง ุฎุงุตูุฉ ุชุญููู ุฃู ููุฏูู
                else if (ุจูุงูุงุช.result.download) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.result.download;
                    ุนููุงู = ุจูุงูุงุช.result.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } else if (ุจูุงูุงุช.result.video) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.result.video;
                    ุนููุงู = ุจูุงูุงุช.result.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                }
            }
            
            if (!ููุฏูู_ููุณ && ุจูุงูุงุช.data) {
                if (typeof ุจูุงูุงุช.data ===  object  && ุจูุงูุงุช.data.url) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.data.url;
                    ุนููุงู = ุจูุงูุงุช.data.title || ุจูุงูุงุช.data.caption || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } else if (typeof ุจูุงูุงุช.data ===  string  && ุจูุงูุงุช.data.startsWith( http )) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.data;
                    ุนููุงู = ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } else if (Array.isArray(ุจูุงูุงุช.data) && ุจูุงูุงุช.data.length > 0) {
                    // ุชูุณูู ุงููุตูููุฉ - ุงุจุญุซ ุนู ุฃูุถู ุฌูุฏุฉ
                    const ููุฏูู_HD = ุจูุงูุงุช.data.find(ุนูุตุฑ => (ุนูุตุฑ.quality ===  HD  || ุนูุตุฑ.quality ===  high ) && (ุนูุตุฑ.format ===  mp4  || !ุนูุตุฑ.format));
                    const ููุฏูู_SD = ุจูุงูุงุช.data.find(ุนูุตุฑ => (ุนูุตุฑ.quality ===  SD  || ุนูุตุฑ.quality ===  low ) && (ุนูุตุฑ.format ===  mp4  || !ุนูุตุฑ.format));
                    ููุฏูู_ููุณ = ููุฏูู_HD?.url || ููุฏูู_SD?.url || ุจูุงูุงุช.data[0]?.url;
                    ุนููุงู = ููุฏูู_HD?.title || ููุฏูู_SD?.title || ุจูุงูุงุช.data[0]?.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } else if (ุจูุงูุงุช.data.download) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.data.download;
                    ุนููุงู = ุจูุงูุงุช.data.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                } else if (ุจูุงูุงุช.data.video) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.data.video;
                    ุนููุงู = ุจูุงูุงุช.data.title || ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
                }
            }
            
            if (!ููุฏูู_ููุณ && ุจูุงูุงุช.url) {
                ููุฏูู_ููุณ = ุจูุงูุงุช.url;
                ุนููุงู = ุจูุงูุงุช.title || ุจูุงูุงุช.caption || "ููุฏูู ููุณุจูู";
            }
            
            if (!ููุฏูู_ููุณ && ุจูุงูุงุช.download) {
                ููุฏูู_ููุณ = ุจูุงูุงุช.download;
                ุนููุงู = ุจูุงูุงุช.title || "ููุฏูู ููุณุจูู";
            }
            
            if (!ููุฏูู_ููุณ && ุจูุงูุงุช.video) {
                if (typeof ุจูุงูุงุช.video ===  string ) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.video;
                } else if (ุจูุงูุงุช.video.url) {
                    ููุฏูู_ููุณ = ุจูุงูุงุช.video.url;
                }
                ุนููุงู = ุจูุงูุงุช.title || ุจูุงูุงุช.video.title || "ููุฏูู ููุณุจูู";
            }
        }

        if (!ููุฏูู_ููุณ) {
            return await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
                text:  โ ูุดู ูู ุงูุญุตูู ุนูู ุฑุงุจุท ุงูููุฏูู ูู ููุณุจูู.\n\nุงูุฃุณุจุงุจ ุงููุญุชููุฉ:\nโข ุงูููุฏูู ุฎุงุต ุฃู ูุญุฐูู\nโข ุงูุฑุงุจุท ุบูุฑ ุตุงูุญ\nโข ุงูููุฏูู ุบูุฑ ูุชุงุญ ููุชุญููู\n\nูุฑุฌู ุชุฌุฑุจุฉ ุฑุงุจุท ููุฏูู ููุณุจูู ูุฎุชูู. 
            }, { quoted: ุฑุณุงูุฉ });
        }

        // ุญุงูู ุฃููุงู ุทุฑููุฉ ุงูุฑุงุจุท (ุฃูุซุฑ ููุซูููุฉ)
        try {
            const ุชุณููุฉ = ุนููุงู ? `ุชู ุงูุชุญููู ุจูุงุณุทุฉ ุงูููู ุตูุฑ\n\n๐ ุงูุนููุงู: ${ุนููุงู}` : "ุชู ุงูุชุญููู ุจูุงุณุทุฉ ุงูููู ุตูุฑ";
            
            await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                video: { url: ููุฏูู_ููุณ },
                mimetype: "video/mp4",
                caption: ุชุณููุฉ
            }, { quoted: ุฑุณุงูุฉ });
            
            return;
        } catch (ุฎุทุฃ_ุงูุฑุงุจุท) {
            console.error(`ูุดูุช ุทุฑููุฉ ุงูุฑุงุจุท: ${ุฎุทุฃ_ุงูุฑุงุจุท.message}`);
            
            // ุงูุฑุฌูุน ุฅูู ุทุฑููุฉ ุงููุฎุฒู ุงููุคูุช
            try {
                // ุฅูุดุงุก ูุฌูุฏ ูุคูุช ุฅุฐุง ูู ููู ููุฌูุฏุงู
                const ูุฌูุฏ_ูุคูุช = path.join(process.cwd(),  tmp );
                if (!fs.existsSync(ูุฌูุฏ_ูุคูุช)) {
                    fs.mkdirSync(ูุฌูุฏ_ูุคูุช, { recursive: true });
                }

                // ุฅูุดุงุก ูุณุงุฑ ุงูููู ุงููุคูุช
                const ููู_ูุคูุช = path.join(ูุฌูุฏ_ูุคูุช, `ููุณ_${Date.now()}.mp4`);

                // ุชุญููู ุงูููุฏูู
                const ุงุณุชุฌุงุจุฉ_ุงูููุฏูู = await axios({
                    method:  GET ,
                    url: ููุฏูู_ููุณ,
                    responseType:  stream ,
                    timeout: 60000,
                    headers: {
                         User-Agent :  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 ,
                         Accept :  video/mp4,video/*;q=0.9,*/*;q=0.8 ,
                         Accept-Language :  en-US,en;q=0.5 ,
                         Referer :  https://www.facebook.com/ 
                    }
                });

                const ุงููุงุชุจ = fs.createWriteStream(ููู_ูุคูุช);
                ุงุณุชุฌุงุจุฉ_ุงูููุฏูู.data.pipe(ุงููุงุชุจ);

                await new Promise((ุญู, ุฑูุถ) => {
                    ุงููุงุชุจ.on( finish , ุญู);
                    ุงููุงุชุจ.on( error , ุฑูุถ);
                });

                // ุงูุชุญูู ููุง ุฅุฐุง ุชู ุชุญููู ุงูููู ุจูุฌุงุญ
                if (!fs.existsSync(ููู_ูุคูุช) || fs.statSync(ููู_ูุคูุช).size === 0) {
                    throw new Error( ูุดู ูู ุชุญููู ุงูููุฏูู );
                }

                // ุฅุฑุณุงู ุงูููุฏูู
                const ุชุณููุฉ = ุนููุงู ? `ุชู ุงูุชุญููู ุจูุงุณุทุฉ ุงููุฑ ุงูุญุทุงูู\n\n๐ ุงูุนููุงู: ${ุนููุงู}` : "ุชู ุงูุชุญููู ุจูุงุณุทุฉ ุงููุฑ ุงูุญุทุงูู";
                
                await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, {
                    video: { url: ููู_ูุคูุช },
                    mimetype: "video/mp4",
                    caption: ุชุณููุฉ
                }, { quoted: ุฑุณุงูุฉ });

                // ุชูุธูู ุงูููู ุงููุคูุช
                try {
                    fs.unlinkSync(ููู_ูุคูุช);
                } catch (ุฎุทุฃ) {
                    console.error( ุฎุทุฃ ูู ุชูุธูู ุงูููู ุงููุคูุช: , ุฎุทุฃ);
                }
                return;
            } catch (ุฎุทุฃ_ุงููุฎุฒู_ุงููุคูุช) {
                console.error(`ูุดูุช ุทุฑููุฉ ุงููุฎุฒู ุงููุคูุช ุฃูุถุงู: ${ุฎุทุฃ_ุงููุฎุฒู_ุงููุคูุช.message}`);
                throw new Error( ูุดูุช ููุชุง ุทุฑููุชุง ุงูุฑุงุจุท ูุงููุฎุฒู ุงููุคูุช );
            }
        }

    } catch (ุฎุทุฃ) {
        console.error( ุฎุทุฃ ูู ุฃูุฑ ููุณุจูู: , ุฎุทุฃ);
        await ุณูู.sendMessage(ูุนุฑู_ุงูุฏุฑุฏุดุฉ, { 
            text: "ุญุฏุซ ุฎุทุฃ. ูุฏ ุชููู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ูุนุทูุฉ. ุงูุฎุทุฃ: " + ุฎุทุฃ.message
        }, { quoted: ุฑุณุงูุฉ });
    }
}

module.exports = ุฃูุฑ_ููุณุจูู;